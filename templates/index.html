<!-- templates/index.html -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Controle</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; padding: 40px; }
    .table th, .table td { vertical-align: middle; }
    .form-inline { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn-sm { padding: 0.25rem 0.5rem; }
    .text-success-small {
      font-size: 0.85rem;
      color: #198754;
      margin-left: 8px;
    }
    /* Estilos para texto piscante */
    .blink {
      animation: blink-animation 1s steps(1, start) infinite;
      color: #dc3545; /* vermelho */
      font-weight: bold;
    }
    @keyframes blink-animation {
      50% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Painel de Controle</h1>
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>MAC</th>
          <th>Nome (Editar)</th>
          <th>IP</th>
          <th>Status</th>
          <th>Expiração</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for mac, data in clients.items() %}
        <tr>
          <!-- Coluna MAC -->
          <td class="text-break">{{ mac }}</td>

          <!-- Coluna Nome + Expiração (formulário de renomear) -->
          <td>
            <form action="/rename/{{ mac }}" method="post" class="form-inline">
              <!-- Campo para editar nome -->
              <input type="text" name="nome" value="{{ data.nome }}" class="form-control form-control-sm" required />

              <!-- Campo para escolher data/hora exata de expiração -->
              <label class="mb-0">Data Expira:</label>
              <input type="datetime-local" name="expiration_date" class="form-control form-control-sm"
                     value="{{ data.expiration[:16] if data.expiration }}" />

              <!-- Campo para definir número de horas até expirar -->
              <label class="mb-0">Horas:</label>
              <input type="number" name="expiration_hours" class="form-control form-control-sm" min="1" style="width:80px;" />

              <!-- Botão Salvar -->
              <button type="submit" class="btn btn-primary btn-sm">Salvar</button>

              <!-- Indica visualmente se já está cadastrado (não temporário) -->
              {% if mac not in temp_clients %}
                <span class="text-success-small">✔️ Cadastrado</span>
              {% endif %}
            </form>
          </td>

          <!-- Coluna IP -->
          <td>{{ data.ip }}</td>

          <!-- Coluna Status -->
          <td>
            {% if data.ativo %}
              <span class="badge bg-success">Ativo</span>
            {% else %}
              <span class="badge bg-danger">Bloqueado</span>
            {% endif %}
          </td>

          <!-- Coluna Expiração / Contador -->
          <td>
            <!-- O atributo data-expiration recebe a string ISO ou fica vazio -->
            <span class="countdown" data-expiration="{{ data.expiration if data.expiration }}"></span>
          </td>

          <!-- Coluna Botões de Ação -->
          <td>
            <form action="/set/{{ mac }}/ACTIVE" method="post" style="display:inline">
              <button type="submit" class="btn btn-success btn-sm">Ativar</button>
            </form>
            <form action="/set/{{ mac }}/BLOCKED" method="post" style="display:inline">
              <button type="submit" class="btn btn-danger btn-sm">Bloquear</button>
            </form>
            <form action="/delete/{{ mac }}" method="post" style="display:inline"
                  onsubmit="return confirm('Tem certeza que deseja excluir este cliente?');">
              <button type="submit" class="btn btn-warning btn-sm">Excluir</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script para atualizar o contador de cada linha -->
  <script>
    function updateCountdowns() {
      document.querySelectorAll('.countdown').forEach(function(span) {
        const exp = span.getAttribute('data-expiration');
        if (!exp) {
          span.textContent = "";
          return;
        }

        // Criamos um objeto Date assumindo que a string está em UTC ("YYYY-MM-DDTHH:MM:SSZ")
        const expDate = new Date(exp);
        const now = new Date();
        const diffMs = expDate - now;

        if (diffMs <= 0) {
          // Já expirou
          span.textContent = 'Expirado';
          span.classList.add('blink');
        } else {
          // Calcula dias, horas e minutos restantes
          const totalSeconds = Math.floor(diffMs / 1000);
          const days = Math.floor(totalSeconds / 86400);
          const hours = Math.floor((totalSeconds % 86400) / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);

          let texto = '';
          if (days > 0) {
            texto += days + 'd ';
          }
          if (hours > 0 || days > 0) {
            texto += hours + 'h ';
          }
          texto += minutes + 'm';

          span.textContent = texto;
          span.classList.remove('blink');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      updateCountdowns();
      // Atualiza a cada minuto (60000 ms)
      setInterval(updateCountdowns, 60000);
    });
  </script>
</body>
</html>
